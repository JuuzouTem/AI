<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çoklu AI Sohbet Arayüzü (OpenRouter Destekli)</title>
    <style>
        /* Genel Stil Ayarları */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: #1c1e21;
        }

        /* Üst Kısım (API Anahtarları ve Model Seçimi) */
        .settings-container {
            background-color: #ffffff;
            padding: 15px 20px;
            border-bottom: 1px solid #dddfe2;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            max-height: 40vh; /* Ayar bölümünün çok büyümesini engelle */
            overflow-y: auto; /* Gerekirse kaydırma */
        }

        .settings-container h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #3b5998;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .provider-settings label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #606770;
        }

        .provider-settings input[type="password"],
        .provider-settings input[type="text"], /* Model input için */
        .provider-settings select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .active-selection {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e4e6eb;
            display: flex; /* Yan yana hizalama için */
            flex-wrap: wrap; /* Küçük ekranlarda alt alta */
            gap: 15px;
            align-items: center;
        }
         .active-selection label {
             font-weight: bold;
             margin-right: 5px; /* Input/Select ile arasına boşluk */
             white-space: nowrap; /* Etiketin kırılmasını engelle */
         }
         .active-selection select,
         .active-selection input[type="text"] { /* Model input için */
              padding: 8px 10px;
              border: 1px solid #ccd0d5;
              border-radius: 6px;
              font-size: 14px;
              min-width: 180px; /* Genişlik ayarı */
         }

        /* OpenRouter Model Input'u başlangıçta gizle */
        #modelInputContainer {
            display: none;
        }

        /* Sohbet Alanı */
        #chatbox {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 75%;
            line-height: 1.4;
            word-wrap: break-word;
            font-size: 0.95em;
        }

        .user-message {
            background-color: #0084ff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background-color: #e4e6eb;
            color: #050505;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            /* AI mesajlarının içindeki kod bloklarının taşmasını engellemek için */
            max-width: 90%; /* Daha geniş olabilir */
        }
         .ai-message .sender-tag {
             display: block;
             font-size: 0.75em;
             font-weight: bold;
             color: #606770;
             margin-bottom: 3px;
             opacity: 0.8;
         }

         .error-message {
            background-color: #fdecea;
            color: #a31a1a;
            border: 1px solid #f5c6cb;
            align-self: stretch; /* Tam genişlik */
            max-width: 100%;   /* Tam genişlik */
            border-radius: 6px;
            font-weight: bold;
         }

         .loading-message {
             font-style: italic;
             color: #606770;
             align-self: flex-start;
             background-color: #e4e6eb;
         }

        /* --- Kod Bloğu Stilleri --- */
        .code-wrapper {
            background-color: #282c34; /* Koyu arka plan */
            border-radius: 8px;
            margin-top: 8px; /* Mesaj metninden biraz boşluk */
            overflow: hidden; /* İçerik taşmasını engelle */
            border: 1px solid #4a4f58;
            /* max-width: 100%; Kapsayıcısının genişliğini aşmaması için */
        }

        .code-toolbar {
            display: flex;
            justify-content: space-between; /* Dil adı sola, butonlar sağa */
            align-items: center;
            background-color: #3c4048; /* Biraz daha açık toolbar */
            padding: 5px 12px;
            border-bottom: 1px solid #4a4f58;
        }

        .code-lang {
            font-size: 0.8em;
            color: #abb2bf; /* Açık gri */
            font-weight: bold;
            text-transform: uppercase;
        }

        .code-toolbar button {
            background-color: #528bff; /* Mavi tonu */
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 8px; /* Butonlar arası boşluk */
            transition: background-color 0.2s ease;
            display: inline-flex; /* İkon ve metni yan yana hizala */
            align-items: center;
        }

        .code-toolbar button:hover {
            background-color: #4073d9; /* Hover rengi */
        }
        .code-toolbar button:disabled {
             background-color: #6c757d;
             cursor: not-allowed;
         }

         .code-toolbar button .btn-text { /* Sadece metin için */
             margin-left: 4px; /* İkon ve metin arası boşluk */
         }

        .code-wrapper pre {
            margin: 0; /* pre etiketinin varsayılan margin'ini kaldır */
            padding: 15px;
            overflow-x: auto; /* Yatay kaydırma */
            background-color: transparent; /* Arka planı wrapper'dan alır */
            color: #abb2bf; /* Kod rengi */
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            white-space: pre; /* Boşlukları koru */
        }

        .code-wrapper pre code {
             display: block; /* Kodun tamamını kapsaması için */
             box-sizing: border-box;
        }
        /* --- Kod Bloğu Stilleri Bitiş --- */

        /* --- YENİ: Markdown Formatlama Stilleri --- */
        .ai-message strong {
            font-weight: bold;
        }

        .ai-message em {
            font-style: italic;
        }

        /* Satır içi kod için. Kod bloğundaki code ile çakışmaması için daha spesifik */
        .ai-message > div > p code,
        .ai-message > div > li code,
        .ai-message > div code:not(pre code) { /* pre içindeki code'ları hariç tut */
            background-color: #f0f0f0; /* Açık gri arka plan */
            padding: 0.1em 0.4em;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #333; /* Koyu gri metin */
            border: 1px solid #e0e0e0;
        }

        .ai-message ul,
        .ai-message ol {
            margin-top: 0.6em;
            margin-bottom: 0.6em;
            padding-left: 25px; /* Liste girintisi */
        }
        .ai-message ul ul, /* İç içe listeler için daha fazla girinti */
        .ai-message ol ol,
        .ai-message ul ol,
        .ai-message ol ul {
            margin-top: 0.2em;
            margin-bottom: 0.2em;
            padding-left: 20px;
        }

        .ai-message li {
            margin-bottom: 0.3em; /* Liste öğeleri arası boşluk */
            line-height: 1.5; /* Liste öğelerinin okunabilirliği */
        }
         .ai-message p { /* Paragraflar arası boşluk için */
             margin-top: 0.5em;
             margin-bottom: 0.5em;
         }
         .ai-message p:first-child {
             margin-top: 0;
         }
          .ai-message p:last-child {
             margin-bottom: 0;
         }
        /* --- Markdown Formatlama Stilleri Bitiş --- */


        /* Giriş Alanı */
        .input-area {
            display: flex;
            padding: 10px 20px;
            background-color: #ffffff;
            border-top: 1px solid #dddfe2;
        }

        #userInput {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid #ccd0d5;
            border-radius: 20px;
            font-size: 15px;
            margin-right: 10px;
            outline: none;
        }
         #userInput:focus {
             border-color: #3b5998;
         }

        #sendButton {
            padding: 10px 20px;
            background-color: #3b5998;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        #sendButton:hover {
            background-color: #334d84;
        }
        #sendButton:disabled {
             background-color: #a0aec0;
             cursor: not-allowed;
         }

         /* Güvenlik Uyarısı */
        .security-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            border-bottom: 1px solid #ffeeba;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="security-warning">
        <strong>⚠️ CİDDİ GÜVENLİK UYARISI:</strong> API anahtarlarınızı tarayıcıya girmek büyük bir risktir. Bu aracı yalnızca %100 güvendiğiniz kişisel bilgisayarınızda kullanın. ASLA herkese açık veya paylaşılan bilgisayarlarda kullanmayın.
    </div>

    <div class="settings-container">
        <h2>API Ayarları ve Model Seçimi</h2>
        <div class="settings-grid">
            <div class="provider-settings">
                <label for="openrouterApiKey">OpenRouter API Anahtarı:</label>
                <input type="password" id="openrouterApiKey" placeholder="sk-or-...">
            </div>
            <div class="provider-settings">
                <label for="openaiApiKey">OpenAI (ChatGPT) API Anahtarı:</label>
                <input type="password" id="openaiApiKey" placeholder="sk-...">
            </div>
            <div class="provider-settings">
                <label for="geminiApiKey">Google Gemini API Anahtarı:</label>
                <input type="password" id="geminiApiKey" placeholder="AIza...">
            </div>
             <div class="provider-settings">
                <label for="groqApiKey">Groq API Anahtarı:</label>
                <input type="password" id="groqApiKey" placeholder="gsk_...">
            </div>
            <div class="provider-settings">
                <label for="claudeApiKey">Anthropic (Claude) API Anahtarı:</label>
                <input type="password" id="claudeApiKey" placeholder="sk-ant-...">
                 <small style="font-size:11px; color:#666;">(Ek başlıklar gerektirebilir)</small>
            </div>
            <div class="provider-settings">
                <label for="deepseekApiKey">DeepSeek API Anahtarı:</label>
                <input type="password" id="deepseekApiKey" placeholder="dk_...">
                <small style="font-size:11px; color:#666;">(Varsayılan OpenAI formatı)</small>
            </div>
             <div class="provider-settings">
                <label for="qwenApiKey">Qwen (Alibaba) API Anahtarı:</label>
                <input type="password" id="qwenApiKey" placeholder="sk-...">
                <small style="font-size:11px; color:#666;">(Varsayılan OpenAI formatı)</small>
            </div>
        </div>

        <div class="active-selection">
             <div>
                 <label for="aiProviderSelect">Aktif Sağlayıcı:</label>
                 <select id="aiProviderSelect">
                     <option value="openrouter">OpenRouter</option>
                     <option value="openai">OpenAI (ChatGPT)</option>
                     <option value="gemini">Google Gemini</option>
                     <option value="groq">Groq</option>
                     <option value="claude">Anthropic Claude</option>
                     <option value="deepseek">DeepSeek (Deneysel)</option>
                     <option value="qwen">Qwen (Deneysel)</option>
                 </select>
             </div>
             <!-- Model Seçim Alanı (Dinamik olarak değişecek) -->
             <div id="modelSelectContainer">
                 <label for="modelSelect">Model:</label>
                 <select id="modelSelect">
                     <!-- Modeller JS ile doldurulacak -->
                 </select>
             </div>
             <div id="modelInputContainer">
                 <label for="modelInput">Model Adı:</label>
                 <input type="text" id="modelInput" placeholder="Örn: google/gemini-pro">
             </div>
        </div>
    </div>

    <div id="chatbox">
        <div class="message ai-message">
             <span class="sender-tag">Sistem</span>
             <div>Merhaba! Hangi AI ile sohbet etmek istersiniz? Lütfen ilgili API anahtarını girin, sağlayıcıyı ve modeli seçin/girin.</div>
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Mesajınızı buraya yazın...">
        <button id="sendButton">Gönder</button>
    </div>

    <script>
        // --- DOM Elementleri ---
        const chatbox = document.getElementById('chatbox');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const aiProviderSelect = document.getElementById('aiProviderSelect');
        const modelSelectContainer = document.getElementById('modelSelectContainer');
        const modelSelect = document.getElementById('modelSelect');
        const modelInputContainer = document.getElementById('modelInputContainer');
        const modelInput = document.getElementById('modelInput');

        // API Anahtar Inputları
        const apiKeysInputs = {
            openrouter: document.getElementById('openrouterApiKey'),
            openai: document.getElementById('openaiApiKey'),
            gemini: document.getElementById('geminiApiKey'),
            groq: document.getElementById('groqApiKey'),
            claude: document.getElementById('claudeApiKey'),
            deepseek: document.getElementById('deepseekApiKey'),
            qwen: document.getElementById('qwenApiKey')
        };

        // --- Sohbet Geçmişi ---
        let conversationHistory = [];

        // --- API Yapılandırmaları ---
        const apiConfigs = {
             openrouter: {
                 apiKeyInput: apiKeysInputs.openrouter,
                 endpoint: 'https://openrouter.ai/api/v1/chat/completions',
                 buildHeaders: (apiKey) => ({
                     'Content-Type': 'application/json',
                     'Authorization': `Bearer ${apiKey}`,
                     // 'HTTP-Referer': 'YOUR_SITE_URL', // İsteğe bağlı
                     // 'X-Title': 'YOUR_SITE_NAME' // İsteğe bağlı
                 }),
                 buildBody: (model, history) => ({
                     model: model,
                     messages: history.map(msg => ({
                         role: msg.role === 'model' ? 'assistant' : msg.role,
                         content: msg.content
                     }))
                 }),
                 parseResponse: (data) => data.choices?.[0]?.message?.content?.trim()
             },
            openai: {
                apiKeyInput: apiKeysInputs.openai,
                models: ["gpt-4o", "gpt-4-turbo", "gpt-3.5-turbo"],
                endpoint: 'https://api.openai.com/v1/chat/completions',
                buildHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                buildBody: (model, history) => ({ model: model, messages: history.map(msg => ({ role: msg.role === 'model' ? 'assistant' : msg.role, content: msg.content })) }),
                parseResponse: (data) => data.choices?.[0]?.message?.content?.trim()
            },
             gemini: {
                 apiKeyInput: apiKeysInputs.gemini,
                 models: ["gemini-1.5-flash-latest", "gemini-1.5-pro-latest", "gemini-pro"],
                 getEndpoint: (model, apiKey) => `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
                 buildHeaders: (apiKey) => ({ 'Content-Type': 'application/json' }),
                 buildBody: (model, history) => ({ contents: history.map(msg => ({ role: msg.role === 'assistant' ? 'model' : msg.role, parts: [{ text: msg.content }] })) }),
                 parseResponse: (data) => data.candidates?.[0]?.content?.parts?.[0]?.text?.trim(),
                 useModelRole: true
            },
             groq: {
                apiKeyInput: apiKeysInputs.groq,
                models: ["llama3-8b-8192", "llama3-70b-8192", "mixtral-8x7b-32768", "gemma-7b-it"],
                endpoint: 'https://api.groq.com/openai/v1/chat/completions',
                buildHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                buildBody: (model, history) => ({ model: model, messages: history.map(msg => ({ role: msg.role === 'model' ? 'assistant' : msg.role, content: msg.content })) }),
                parseResponse: (data) => data.choices?.[0]?.message?.content?.trim()
            },
             claude: {
                 apiKeyInput: apiKeysInputs.claude,
                 models: ["claude-3-opus-20240229", "claude-3-sonnet-20240229", "claude-3-haiku-20240307"],
                 endpoint: 'https://api.anthropic.com/v1/messages',
                 buildHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01' }),
                 buildBody: (model, history) => ({ model: model, max_tokens: 1024, messages: history.map(msg => ({ role: msg.role === 'model' ? 'assistant' : msg.role, content: msg.content })) }),
                 parseResponse: (data) => data.content?.[0]?.text?.trim()
             },
              deepseek: {
                apiKeyInput: apiKeysInputs.deepseek,
                models: ["deepseek-chat", "deepseek-coder"],
                endpoint: 'https://api.deepseek.com/chat/completions',
                buildHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                buildBody: (model, history) => ({ model: model, messages: history.map(msg => ({ role: msg.role === 'model' ? 'assistant' : msg.role, content: msg.content })) }),
                parseResponse: (data) => data.choices?.[0]?.message?.content?.trim()
            },
             qwen: {
                apiKeyInput: apiKeysInputs.qwen,
                models: ["qwen-turbo", "qwen-plus", "qwen-max"],
                endpoint: 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                buildHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                buildBody: (model, history) => ({ model: model, input: { messages: history.map(msg => ({ role: msg.role === 'model' ? 'assistant' : msg.role, content: msg.content }))}, parameters: {} }),
                parseResponse: (data) => data.output?.choices?.[0]?.message?.content?.trim() || data.output?.text?.trim()
             }
        };

        // --- Yardımcı Fonksiyonlar ---

        /**
         * Basit Markdown formatlamasını (kalın, italik, satır içi kod, listeler) HTML'e dönüştürür.
         * Dikkat: Bu tam bir Markdown ayrıştırıcısı değildir, temel durumları ele alır.
         * Kod blokları (```) bu fonksiyon ÇAĞRILMADAN ÖNCE ayrılmalıdır.
         * @param {string} rawText - Ham metin girdisi.
         * @returns {string} - HTML formatında çıktı.
         */
        function parseMarkdown(rawText) {
            if (!rawText) return '';

            let html = '';
            const lines = rawText.trim().split('\n');
            let listType = null; // null, 'ul', 'ol'
            let listLevel = 0; // Mevcut liste girinti seviyesi
            let paragraphBuffer = []; // Ardışık metin satırları için tampon

            // Satır içi formatlamayı (bold, italic, code) uygular
            function applyInlineFormatting(lineContent) {
                // Satır içi kod (`...`)
                lineContent = lineContent.replace(/`([^`]+?)`/g, '<code>$1</code>');
                // Kalın+İtalik (***...*** veya ___...___)
                lineContent = lineContent.replace(/(?<!\\)\*\*\*([^\*]+?)\*\*\*/g, '<strong><em>$1</em></strong>');
                lineContent = lineContent.replace(/(?<!\\)___([^_]+?)___/g, '<strong><em>$1</em></strong>');
                // Kalın (**...** veya __...__)
                lineContent = lineContent.replace(/(?<!\\)\*\*([^\*]+?)\*\*/g, '<strong>$1</strong>');
                lineContent = lineContent.replace(/(?<!\\)__([^_]+?)__/g, '<strong>$1</strong>');
                // İtalik (*...* veya _..._)
                lineContent = lineContent.replace(/(?<!\\)\*([^\*]+?)\*/g, '<em>$1</em>');
                lineContent = lineContent.replace(/(?<!\\)_([^_]+?)_/g, '<em>$1</em>');
                // Kaçış karakterleri (\*, \_)
                lineContent = lineContent.replace(/\\\*/g, '*');
                lineContent = lineContent.replace(/\\_/g, '_');
                lineContent = lineContent.replace(/\\`/g, '`');
                return lineContent;
            }

            // Paragraf tamponunu HTML'e boşaltır
            function flushParagraphBuffer() {
                if (paragraphBuffer.length > 0) {
                    // Her satıra formatlama uygula ve <br> ile birleştir, sonra <p> içine al
                    const paragraphContent = paragraphBuffer.map(applyInlineFormatting).join('<br>');
                     html += `<p>${paragraphContent}</p>\n`;
                     paragraphBuffer = [];
                }
            }

            // Gerekiyorsa açık olan listeyi/listeleri kapatır
            function closeLists(targetLevel = 0) {
                 while (listLevel > targetLevel) {
                    if (listType === 'ul') { html += '</ul>\n'; }
                    else if (listType === 'ol') { html += '</ol>\n'; }
                    listLevel--;
                    // TODO: Üst seviyedeki listelerin tipini takip etmek gerekir (şu an basit varsayım)
                 }
                 if (listLevel === 0) listType = null;
            }

            lines.forEach(line => {
                const trimmedLine = line.trim();
                // Girintiyi ve liste işaretçisini yakala (daha iyi seviye)
                const listMatch = line.match(/^(\s*)(([\*\-\+])|(\d+)\.)\s+(.*)/);
                let currentLevel = 0;
                let currentListType = null;
                let content = '';

                if (listMatch) {
                    const indentSpaces = listMatch[1].length;
                    // Basit girinti seviyesi tahmini (her 2-4 boşluk için bir seviye artır)
                    currentLevel = Math.floor(indentSpaces / 2) + 1; // 2 boşluk = 1 seviye
                    content = listMatch[5];
                    currentListType = listMatch[3] ? 'ul' : 'ol'; // *, -, + ise ul, sayı ise ol
                }

                if (listMatch) {
                    flushParagraphBuffer(); // Önceki paragrafı bitir

                    if (currentLevel > listLevel) { // Yeni iç liste
                         if(listLevel > 0 && listType !== currentListType){
                            // İç içe farklı tipte liste pek standart değil, ama yine de yeni başlat
                         }
                         html += (currentListType === 'ul' ? '<ul>\n' : '<ol>\n');
                         listLevel = currentLevel;
                         listType = currentListType;
                    } else if (currentLevel < listLevel) { // Üst seviyeye dön
                         closeLists(currentLevel);
                         // Seviye değiştiğinde tip de değişmiş olabilir, kontrol et
                         if(listType !== currentListType) {
                             closeLists(currentLevel - 1); // Kapatıp yeni tip aç
                             html += (currentListType === 'ul' ? '<ul>\n' : '<ol>\n');
                             listLevel = currentLevel;
                             listType = currentListType;
                         }
                    } else if (listType !== currentListType) { // Aynı seviye ama tip değişti
                         closeLists(currentLevel - 1); // Kapatıp yeni tip aç
                         html += (currentListType === 'ul' ? '<ul>\n' : '<ol>\n');
                         listLevel = currentLevel;
                         listType = currentListType;
                    }

                    html += `<li>${applyInlineFormatting(content)}</li>\n`; // Liste öğesini ekle
                } else {
                    // Liste öğesi değilse
                    closeLists(); // Açık tüm listeleri kapat
                    if (trimmedLine) {
                        // Boş olmayan satırları paragrafa ekle
                        paragraphBuffer.push(line); // Orijinal satırı al
                    } else {
                        // Boş satır -> paragraf sonu
                        flushParagraphBuffer();
                    }
                }
            });

            // Döngü sonrası kalanları temizle
            flushParagraphBuffer();
            closeLists();

            return html.trim(); // Sonuç HTML'i döndür
        }

        // --- GÜNCELLENMİŞ addMessageToChatbox Fonksiyonu ---
        function addMessageToChatbox(sender, message, provider = null, type = 'normal') {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            if (type === 'error') {
                messageDiv.classList.add('error-message');
                messageDiv.textContent = `❌ Hata (${provider || 'Sistem'}): ${message}`;
            } else if (type === 'loading') {
                messageDiv.classList.add('ai-message', 'loading-message');
                messageDiv.innerHTML = `<span class="sender-tag">${provider || 'AI'} yazıyor...</span>⏳`;
                messageDiv.id = 'loading-indicator';
            } else {
                // Normal mesaj (Kullanıcı veya AI)
                messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');

                // AI mesajıysa özel işlem yap (Sistem mesajları hariç)
                if (sender !== 'user' && provider !== 'Sistem') {
                    // Önce gönderen etiketi ekle
                    const senderTag = document.createElement('span');
                    senderTag.classList.add('sender-tag');
                    senderTag.textContent = provider || 'AI';
                    messageDiv.appendChild(senderTag);

                    // İçerik için bir ana div oluştur (bu, kod bloğu dışı içeriği kapsayacak)
                    const contentWrapperDiv = document.createElement('div');

                    // ```lang\ncode\n``` formatını ara
                    const codeBlockRegex = /```(\w*)\n([\s\S]*?)\n```/g; // Global flag önemli
                    let lastIndex = 0;
                    let match;
                    let hasContent = false; // Mesaj div'ine içerik eklendi mi?

                    // Kod bloklarını ve aralarındaki metinleri ayır
                    while ((match = codeBlockRegex.exec(message)) !== null) {
                        // Kod bloğundan önceki metin kısmı
                        const textPart = message.substring(lastIndex, match.index).trim();
                        if (textPart) {
                            // Önceki içerik wrapper'ına markdown'ı ekle
                            const parsedHtml = parseMarkdown(textPart);
                            if (parsedHtml) {
                                contentWrapperDiv.innerHTML += parsedHtml; // Mevcut içeriğe ekle
                                hasContent = true;
                            }
                        }

                        // Mesaj div'ine (varsa) önceki metinleri içeren wrapper'ı ekle
                        if (contentWrapperDiv.innerHTML.trim()) {
                             messageDiv.appendChild(contentWrapperDiv.cloneNode(true)); // Klonlayarak ekle
                             contentWrapperDiv.innerHTML = ''; // Bir sonraki metin bölümü için temizle
                        }


                        // Kod Bloğu
                        const lang = match[1] || 'text';
                        const codeContent = match[2]; // Kodu trim etme!

                        const codeWrapper = document.createElement('div');
                        codeWrapper.className = 'code-wrapper';

                        const toolbar = document.createElement('div');
                        toolbar.className = 'code-toolbar';

                        const langSpan = document.createElement('span'); // Dil etiketi
                        langSpan.className = 'code-lang';
                        langSpan.textContent = lang;

                        const buttonGroup = document.createElement('div'); // Butonları grupla

                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-btn';
                        copyBtn.title = 'Kodu Kopyala';
                        copyBtn.innerHTML = '📄<span class="btn-text">Kopyala</span>'; // İkon + Metin
                        copyBtn.dataset.code = codeContent; // Kodu data attribute olarak ekle

                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'download-btn';
                        downloadBtn.title = 'Kodu İndir';
                        downloadBtn.innerHTML = '💾<span class="btn-text">İndir</span>'; // İkon + Metin
                        downloadBtn.dataset.code = codeContent;
                        downloadBtn.dataset.lang = lang; // Dil bilgisini de ekle

                        buttonGroup.appendChild(copyBtn);
                        buttonGroup.appendChild(downloadBtn);

                        toolbar.appendChild(langSpan); // Dil etiketini ekle
                        toolbar.appendChild(buttonGroup); // Buton grubunu ekle

                        const pre = document.createElement('pre');
                        const code = document.createElement('code');
                        // Sintaks highlight için class (isteğe bağlı, kütüphane gerektirir)
                        code.className = `language-${lang}`;
                        code.textContent = codeContent; // Kodu güvenli şekilde ekle

                        pre.appendChild(code);
                        codeWrapper.appendChild(toolbar);
                        codeWrapper.appendChild(pre);
                        messageDiv.appendChild(codeWrapper); // Kod bloğunu doğrudan mesaj div'ine ekle
                        hasContent = true;
                        // --- Kod Bloğu HTML Bitiş ---

                        lastIndex = codeBlockRegex.lastIndex; // Sonraki aramaya devam et
                    }

                    // Son kod bloğundan sonra kalan metin kısmı
                    const remainingText = message.substring(lastIndex).trim();
                    if (remainingText) {
                         const parsedHtml = parseMarkdown(remainingText);
                         if (parsedHtml) {
                            contentWrapperDiv.innerHTML += parsedHtml; // Kalan metni wrapper'a ekle
                            hasContent = true;
                        }
                    }

                    // Eğer son metin bölümü varsa, onu da mesaj div'ine ekle
                    if (contentWrapperDiv.innerHTML.trim()) {
                         messageDiv.appendChild(contentWrapperDiv);
                    }


                     // Eğer regex hiç eşleşmediyse (kod bloğu yoksa) tüm mesajı işle
                     if (lastIndex === 0 && message.trim() && !hasContent) {
                         const parsedHtml = parseMarkdown(message.trim());
                         if(parsedHtml) {
                             contentWrapperDiv.innerHTML = parsedHtml;
                             messageDiv.appendChild(contentWrapperDiv);
                             hasContent = true;
                         } else if (message.trim()) { // Markdown yoksa düz metin olarak ekle
                             contentWrapperDiv.textContent = message.trim();
                             messageDiv.appendChild(contentWrapperDiv);
                             hasContent = true;
                         }
                     }

                     // Eğer hiçbir içerik eklenmediyse (mesaj tamamen boş veya sadece whitespace ise)
                     if (!hasContent && message.trim().length === 0) {
                         // Boş mesajı göstermemek için bir şey yapma
                         // veya özel bir mesaj göster:
                         // const emptyDiv = document.createElement('div');
                         // emptyDiv.textContent = "[Boş yanıt]";
                         // emptyDiv.style.fontStyle = 'italic';
                         // messageDiv.appendChild(emptyDiv);
                     } else if (!hasContent && message.trim().length > 0) {
                         // Parse edilemeyen veya sadece boşluk olan ama boş olmayan mesaj
                         const fallbackDiv = document.createElement('div');
                         fallbackDiv.textContent = message.trim();
                         messageDiv.appendChild(fallbackDiv);
                     }


                } else { // Kullanıcı veya Sistem mesajı ise direkt ekle (Markdown olmadan)
                    if (sender !== 'user') { // Sistem mesajı için gönderen etiketi
                        const senderTag = document.createElement('span');
                        senderTag.classList.add('sender-tag');
                        senderTag.textContent = provider || 'AI'; // 'Sistem' olabilir
                        messageDiv.appendChild(senderTag);
                    }
                    const contentDiv = document.createElement('div');
                    // Kullanıcı girdisini veya sistem mesajını güvenli bir şekilde ekle
                    contentDiv.textContent = message.trim(); // innerHTML yerine textContent kullan!
                    messageDiv.appendChild(contentDiv);
                }
            }

            // Mesaj kutusunu sadece gerçekten içerik varsa ekle
            // (Örn: Hata veya yükleniyor mesajı değilse ve AI yanıtı boş değilse)
            if (messageDiv.innerHTML.trim() !== '' || type === 'error' || type === 'loading') {
                 chatbox.appendChild(messageDiv);
                 // En alta kaydır
                 chatbox.scrollTop = chatbox.scrollHeight;
            }
            return messageDiv;
        }


        // Seçilen sağlayıcıya göre Model Seçim Arayüzünü güncelle
        function updateModelUI() {
            const selectedProvider = aiProviderSelect.value;
            const config = apiConfigs[selectedProvider];

            if (selectedProvider === 'openrouter') {
                modelSelectContainer.style.display = 'none';
                modelInputContainer.style.display = 'block';
                modelInput.value = localStorage.getItem('openrouter_last_model') || ''; // Kayıtlı modeli yükle
            } else {
                modelInputContainer.style.display = 'none';
                modelSelectContainer.style.display = 'block';

                modelSelect.innerHTML = '';
                if (config && config.models && config.models.length > 0) {
                    config.models.forEach(modelName => {
                        const option = document.createElement('option');
                        option.value = modelName;
                        option.textContent = modelName;
                        modelSelect.appendChild(option);
                    });
                    modelSelect.disabled = false;
                    // Kayıtlı modeli seç (varsa)
                     const savedModel = localStorage.getItem(`${selectedProvider}_last_model`);
                     if (savedModel && config.models.includes(savedModel)) {
                         modelSelect.value = savedModel;
                     }

                } else {
                    const option = document.createElement('option');
                    option.textContent = "Model Yok/Tanımsız";
                    option.value = ""; // Değeri boş olsun
                    modelSelect.appendChild(option);
                    modelSelect.disabled = true;
                    console.warn(`"${selectedProvider}" için model listesi bulunamadı veya tanımsız.`);
                }
            }
             // Başlangıçta veya sağlayıcı değiştiğinde sohbet geçmişini temizle (isteğe bağlı)
             // conversationHistory = [];
             // chatbox.innerHTML = ''; // Sohbet kutusunu temizle
             // addMessageToChatbox('Sistem', 'Sohbet geçmişi temizlendi. Yeni sağlayıcı/model seçildi.', 'Sistem');
        }


        // --- Ana Sohbet Fonksiyonu ---
        async function sendMessage() {
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            const selectedProvider = aiProviderSelect.value;
            const config = apiConfigs[selectedProvider];

            if (!config) {
                addMessageToChatbox('Sistem', 'Geçersiz AI sağlayıcısı seçildi.', selectedProvider, 'error');
                return;
            }

            let selectedModel;
            if (selectedProvider === 'openrouter') {
                selectedModel = modelInput.value.trim();
                if (!selectedModel) {
                     addMessageToChatbox('Sistem', 'Lütfen OpenRouter için bir model adı girin (örn: google/gemini-pro).', 'OpenRouter', 'error');
                     modelInput.focus();
                     return;
                 }
                 localStorage.setItem('openrouter_last_model', selectedModel); // Modeli kaydet
            } else {
                selectedModel = modelSelect.value;
                 if (!selectedModel || modelSelect.disabled) { // Boş değer veya disabled kontrolü
                    addMessageToChatbox('Sistem', 'Lütfen geçerli bir model seçin.', selectedProvider, 'error');
                    modelSelect.focus();
                    return;
                }
                 localStorage.setItem(`${selectedProvider}_last_model`, selectedModel); // Modeli kaydet
            }

            const apiKey = config.apiKeyInput.value.trim();
            if (!apiKey) {
                addMessageToChatbox('Sistem', `Lütfen ${selectedProvider.toUpperCase()} için API anahtarını girin.`, selectedProvider, 'error');
                config.apiKeyInput.focus();
                return;
            }
            // API Anahtarını (geçici olarak) local storage'a kaydet (UYARI: GÜVENLİ DEĞİL)
             localStorage.setItem(`${selectedProvider}_api_key`, apiKey);


            addMessageToChatbox('user', userMessage, 'User');
            conversationHistory.push({ role: "user", content: userMessage });
            userInput.value = '';
            sendButton.disabled = true;

            const providerName = selectedProvider.charAt(0).toUpperCase() + selectedProvider.slice(1); // İlk harfi büyük
            const loadingMessageElement = addMessageToChatbox('ai', 'AI yazıyor...', providerName, 'loading');

            try {
                const endpoint = config.getEndpoint ? config.getEndpoint(selectedModel, apiKey) : config.endpoint;
                const headers = config.buildHeaders(apiKey);
                const body = config.buildBody(selectedModel, conversationHistory);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });

                // Önce yükleniyor mesajını kaldır
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator && loadingIndicator.parentNode === chatbox) { // Hala DOM'da ise kaldır
                     chatbox.removeChild(loadingIndicator);
                }


                if (!response.ok) {
                    let errorData;
                    let errorMessage = `API isteği başarısız oldu. Status: ${response.status} ${response.statusText}`;
                    try {
                        errorData = await response.json();
                        errorMessage = errorData?.error?.message // OpenAI, Groq, OpenRouter
                                       || errorData?.error?.details // Bazen Gemini
                                       || (errorData?.error && typeof errorData.error === 'string' ? errorData.error : null) // Bazen Claude
                                       || errorData?.message    // Gemini (bazen), Claude (bazen)
                                       || errorData?.detail     // Bazı API'ler
                                       || JSON.stringify(errorData); // Son çare
                    } catch (e) {
                        try {
                             const textError = await response.text();
                             if(textError) errorMessage = textError; // JSON değilse text olarak oku
                        }
                        catch (readError) {} // Okuma hatası olursa önceki mesaj kalsın
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                const aiMessage = config.parseResponse(data);

                if (aiMessage !== null && aiMessage !== undefined) { // Boş string geçerli olabilir
                    // AI mesajını işlenmiş olarak ekle (kod blokları ve markdown ayrıştırılacak)
                    addMessageToChatbox('ai', aiMessage, providerName);
                    const assistantRole = config.useModelRole ? 'model' : 'assistant';
                    conversationHistory.push({ role: assistantRole, content: aiMessage });
                } else {
                    console.error("API Yanıtı (Ayrıştırma Sonrası İçerik Yok veya null/undefined):", data);
                    // Yanıt var ama içerik parse edilemediyse veya boşsa kullanıcıya bildir
                    let rawResponseInfo = '';
                    try { rawResponseInfo = JSON.stringify(data).substring(0, 200) + '...'; } catch { rawResponseInfo = '[JSON olmayan yanıt]';}
                    addMessageToChatbox('Sistem', `AI'dan geçerli bir metin yanıtı alınamadı. Yanıt formatı beklenenden farklı olabilir veya yanıt boş. (Raw: ${rawResponseInfo})`, providerName, 'error');
                     // Geçmişe boş mesaj eklememek iyi olabilir
                }

            } catch (error) {
                // Yükleniyor mesajı zaten yukarıda kaldırıldı, tekrar kontrol etmeye gerek yok
                // (Hala duruyorsa kaldır)
                const loadingIndicator = document.getElementById('loading-indicator');
                 if (loadingIndicator && loadingIndicator.parentNode === chatbox) {
                     chatbox.removeChild(loadingIndicator);
                 }

                console.error(`[${providerName}] API Hatası:`, error);
                addMessageToChatbox('Sistem', `Bir hata oluştu: ${error.message}`, providerName, 'error');
                // Hata durumunda son kullanıcı mesajını geçmişten sil (opsiyonel)
                // conversationHistory.pop();
            } finally {
                sendButton.disabled = false;
                userInput.focus();
                // Sohbet kutusunu en alta kaydır (hatadan sonra da)
                 chatbox.scrollTop = chatbox.scrollHeight;
            }
        }

        // --- Olay Dinleyicileri ---
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function (e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }); // Shift+Enter ile satır atla
        aiProviderSelect.addEventListener('change', updateModelUI);
        modelInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && aiProviderSelect.value === 'openrouter') {
                sendMessage();
            }
        });
         modelSelect.addEventListener('change', (event) => {
             const provider = aiProviderSelect.value;
             if (provider !== 'openrouter') {
                 localStorage.setItem(`${provider}_last_model`, event.target.value);
             }
         });
         modelInput.addEventListener('change', (event) => {
             if (aiProviderSelect.value === 'openrouter') {
                 localStorage.setItem('openrouter_last_model', event.target.value);
             }
         });


        // --- Kod Bloğu Butonları için Olay Dinleyicisi ---
        chatbox.addEventListener('click', function(event) {
            const target = event.target; // Tıklanan element

            // Kopyala butonu mu tıklandı?
            const copyButton = target.closest('.copy-btn');
            if (copyButton && !copyButton.disabled) { // Buton disabled değilse çalışsın
                const codeToCopy = copyButton.dataset.code;
                navigator.clipboard.writeText(codeToCopy).then(() => {
                    const btnText = copyButton.querySelector('.btn-text');
                    if (btnText) btnText.textContent = 'Kopyalandı!';
                    copyButton.disabled = true; // Kopyalayınca butonu devre dışı bırak
                    setTimeout(() => {
                         if (btnText) btnText.textContent = 'Kopyala';
                         copyButton.disabled = false; // 2 saniye sonra tekrar aktif et
                    }, 2000);
                }).catch(err => {
                    console.error('Kod kopyalanamadı:', err);
                    // Eski yöntem (güvenli olmayan contextlerde fallback)
                     try {
                         const textArea = document.createElement("textarea");
                         textArea.value = codeToCopy;
                         textArea.style.position = "fixed"; // Görünmez yap
                         textArea.style.left = "-9999px";
                         document.body.appendChild(textArea);
                         textArea.focus();
                         textArea.select();
                         document.execCommand('copy');
                         document.body.removeChild(textArea);

                         // Başarı geri bildirimi (fallback için)
                         const btnText = copyButton.querySelector('.btn-text');
                         if (btnText) btnText.textContent = 'Kopyalandı! (FB)';
                         copyButton.disabled = true;
                         setTimeout(() => {
                            if (btnText) btnText.textContent = 'Kopyala';
                            copyButton.disabled = false;
                         }, 2000);
                     } catch (fallbackErr) {
                         console.error('Fallback kopyalama da başarısız:', fallbackErr);
                         alert('Hata: Kod panoya kopyalanamadı!');
                     }
                });
                return; // İşlem tamamlandı
            }

            // İndir butonu mu tıklandı?
            const downloadButton = target.closest('.download-btn');
            if (downloadButton) {
                const codeToDownload = downloadButton.dataset.code;
                const lang = downloadButton.dataset.lang || 'txt';
                // Dosya adı için daha anlamlı bir şey (örn: ilk satır veya rastgele id) eklenebilir
                const filename = `ai_kod_${Date.now()}.${lang.split(/[^a-zA-Z0-9]/)[0] || 'txt'}`; // Dil adından uzantı türet, geçersiz karakterleri at

                try {
                    const blob = new Blob([codeToDownload], { type: 'text/plain;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href); // Bellek sızıntısını önle
                } catch (err) {
                    console.error('Dosya indirilemedi:', err);
                    alert('Hata: Kod dosyası indirilemedi!');
                }
            }
        });
        // --- Kod Bloğu Butonları için Olay Dinleyicisi Bitiş ---


        // --- Başlangıç Ayarları ---
        // Kayıtlı API Anahtarlarını yükle (UYARI: GÜVENLİ DEĞİL!)
        Object.keys(apiKeysInputs).forEach(providerKey => {
             const savedKey = localStorage.getItem(`${providerKey}_api_key`);
             if (savedKey) {
                 apiKeysInputs[providerKey].value = savedKey;
             }
             // Anahtar değiştikçe kaydet (tarayıcı kapatılana kadar tutar)
             apiKeysInputs[providerKey].addEventListener('input', (event) => {
                localStorage.setItem(`${providerKey}_api_key`, event.target.value);
             });
        });

        updateModelUI(); // Sayfa yüklendiğinde doğru model UI'ını göster
        userInput.focus(); // Kullanıcı girişine odaklan

    </script>

</body>
</html>